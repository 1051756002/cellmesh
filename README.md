# cellmesh
微服务架构游戏服务框架


# 目标

- 服务与服务的对话

    业务逻辑编写不再关注网络，进程。根据预先规划的进程互联拓扑图，找到最高效的通讯方式。

- 通用型可扩展网关

    协助处理客户端长连接心跳及下线通知。封包按规则路由到服务，广播优化等。

- 基于服务发现

    使用服务发现实现服务选择策略，例如：获得一台负载最低的战斗服务器地址；将玩家尽量集中到某台服务器。

- 消息订阅发布

    在订阅和发布者之间选择一条最短路径通信（最短=直连），否则使用hub服务进行中转


# 设计

## Node（节点）

一个Node对应一个进程。

一个Node可以拥有多个不重名的Service。

Node的名称由进程名和动态分配的id组成，例如：game1, game2。动态生成的id保证全局唯一。

## Service（服务）

一个Service为一套连接器或侦听器，挂接消息处理的派发器Dispatcher

一个Service可以由多个实例构成，通过服务发现更新


## Agent（网关）

frontend: 与客户端连接的前端通信的侦听器
维护连入的User连接，使用心跳+底层断开通知确认User断开

backend: 与后台服务器通信的侦听器
维护后台连接，更新客户端连接与后台的路由关系

## Connection Management（连接维护）

从服务发现的服务信息，创建到不同服务间的长连接。同时在这些连接断开时维护连接

逻辑中根据策略从已有连接及信息选择出连接与目标通信，例如：选择负载最低的一台游戏服务器



# FAQ
- 位于同一个Node的A Service调用B Service如何处理?
   这种方式处理逻辑效率较低，底层会提示错误，比不予处理。

# TODO
- [x] 基于Consul的服务发现及Watch机制
- [x] 网关基本逻辑
- [x] 带服务发现的连接器,侦听器
- [x] 网关会话绑定
- [x] 服务发现Consul的KV封装
- [x] 网关路由规则生成,上传和下载
- [x] 系统消息响应入口
- [ ] 网关广播
- [ ] 服务在线人数更新及连接选择
- [ ] 分布式hub
- [ ] 网关心跳处理
- [ ] 登录服务器，JWT验证
- [ ] 玩家数据读取（mysql）,goorm
- [ ] 游戏服务器，成长逻辑，花钱升级等级
- [ ] 社交服务器，聊天逻辑（redis)
- [ ] 机器人